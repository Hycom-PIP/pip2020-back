pipeline {
    agent any
    stages {
      stage('Build') {
                steps {
                    sh 'mvn clean install -DskipTests'
                }
            }
      stage('Run') {
         steps {
             parallel (
                "stream 1": {
                     sh 'java -jar -Dspring.profiles.active=fullTests api/target/api.jar & echo $! > ./pid.file &'
                },
                 "stream 2" : {
                                   sh 'sleep 10s'
                                   dir('integration-tests') {
                                        sh 'mvn test -PfullTests'
                                    }
                                    kill $(cat ./pid.file)
                 }
             )
         }
      }
    }
}
